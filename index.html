<html>
    <head>
        <title>pico sketch</title>
    </head>

    <body>

    <!-- Define your elements -->
        <h1>pico sketch</h1>
        
        <textarea id="displayTextArea"></textarea>










    <!-- Javascript code (No need to look further...) -->        
        <script type="text/javascript">

            let imports = {};
            let memory = null;
            let exports = null;


            /*
            * Javascript Pico Lib
            */
            let utf8Decoder = new TextDecoder("utf-8");
            let utf8Encoder = new TextEncoder("utf-8");

            // Get a string from the memory.
            function GetString(inStrPtr, inStrLength)
            {
                let arr = memory.subarray(inStrPtr, inStrPtr + inStrLength);

                return utf8Decoder.decode(arr);
            }
            // Convert a javascript string into an uint8_t array.
            function ConvertStringToBytes(inJSString)
            {
                return utf8Encoder.encode(inJSString);
            }






            /*
            * Console
            */
            imports['_print'] = function(inStrPtr, inStrLength)
            {
                let strContents = GetString(inStrPtr, inStrLength);

                console.log(strContents);
            };

            imports['_print_err'] = function(inStrPtr, inStrLength)
            {
                let strContents = GetString(inStrPtr, inStrLength);

                console.error(strContents);
            };






            /*
            * Alert
            */
            imports['_alert'] = function(inStrPtr, inStrLength)
            {
                let strContents = GetString(inStrPtr, inStrLength);

                alert(strContents);
            }







            /*
            * Text Area
            */
            imports['_TextArea_Init'] = function(inStrPtr, inStrLen, inWidth, inHeight)
            {
                let elementId = GetString(inStrPtr, inStrLen);

                let textAreaElement = document.getElementById(elementId);

                // resize the element.
                textAreaElement.cols = inWidth;
                textAreaElement.rows = inHeight;
            };

            imports['_TextArea_GetContent'] = function(inStrPtr, inStrLen, outContentsStrPtr, outContentsStrLength)
            {
                let elementId = GetString(inStrPtr, inStrLen);
                let textAreaElement = document.getElementById(elementId);

                // Content is now an array of bytes.
                let content = textAreaElement.value;
                let contentArray = ConvertStringToBytes(content);

                // 1. copy outContentsStrLength of data from the content array
                let contentArraySpan = contentArray.subarray(0, outContentsStrLength); // subarray creates a REFERENCE.

                // 2. paste contentArraySpan bytes to the destination at outContentsStrPtr.
                memory.set(contentArraySpan, outContentsStrPtr);
            };

            imports['_TextArea_SetContent'] = function(inStrPtr, inStrLen, inContentsStrPtr, inContentsStrLen)
            {
                let elementId = GetString(inStrPtr, inStrLen);
                let contents = GetString(inContentsStrPtr, inContentsStrLen);

                let textAreaElement = document.getElementById(elementId);
                textAreaElement.value = contents;
            };




            /*
            * Main entry point
            */
            window.onload = async function ()
            {
                let request = await fetch('binary.wasm');
                let binary = await request.arrayBuffer();
                
                imports['memory'] = new WebAssembly['Memory']({
                    'initial' : 2       // 1 page of memory
                });

                memory = new Uint8Array(imports['memory']['buffer']);


                let program = await WebAssembly['instantiate'](
                    binary,
                    { "env": imports }
                );

                let instance = program['instance'];

                exports = instance['exports'];

                exports['setup']();
            };


            /*
            * DOM Window events
            */
           // Keys
            window.onkeypress = function(inEvent)
            {
                exports["onkeypress"](inEvent.key.charCodeAt(0));
            };

            window.onkeydown = function(inEvent)
            {
                exports["onkeydown"](inEvent.key.charCodeAt(0));
            };

            window.onkeyup = function(inEvent)
            {
                exports["onkeyup"](inEvent.key.charCodeAt(0));
            };



            // Mouse
            window.onclick = function(inEvent)
            {
                exports["onclick"](inEvent.buttons);
            };

            window.onmousedown = function(inEvent)
            {
                exports["onmousedown"](inEvent.buttons);
            }

            window.onmouseup = function(inEvent)
            {
                exports["onmouseup"](inEvent.buttons);
            }

            window.onwheel = function(inEvent)
            {
                exports["onwheel"](inEvent.deltaX, inEvent.deltaY);
            }
        </script>
    </body>
</html>